# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy JAR app to Azure Web App - CaesarCipher

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Java version
        uses: actions/setup-java@v1
        with:
          java-version: '11'

      - name: Gradle Build Action
  # You may pin to the exact commit or the version.
  # uses: gradle/gradle-build-action@749f47bda3e44aa060e82d7b3ef7e40d953bd629
  uses: gradle/gradle-build-action@v2.4.2
  with:
    # Gradle version to use
    gradle-version: # optional
    # When 'true', all caching is disabled. No entries will be written to or read from the cache.
    cache-disabled: # optional
    # When 'true', existing entries will be read from the cache but no entries will be written.
By default this value is 'false' for workflows on the GitHub default branch and 'true' for workflows on other branches.

    cache-read-only: # optional, default is ${{ github.event.repository != null && github.ref_name != github.event.repository.default_branch }}
    # When 'true', entries will not be restored from the cache but will be saved at the end of the Job. 
Setting this to 'true' implies cache-read-only will be 'false'.

    cache-write-only: # optional
    # Paths within Gradle User Home to cache.
    gradle-home-cache-includes: # optional, default is caches
notifications

    # Paths within Gradle User Home to exclude from cache.
    gradle-home-cache-excludes: # optional
    # Gradle command line arguments (supports multi-line input)
    arguments: # optional
    # Path to the root directory of the build
    build-root-directory: # optional
    # Path to the Gradle executable
    gradle-executable: # optional
    # When 'false', no Job Summary will be generated for the Job.
    generate-job-summary: # optional, default is true
    # When 'true', the action will not attempt to restore the Gradle User Home entries from other Jobs.
    gradle-home-cache-strict-match: # optional
    # Used to uniquely identify the current job invocation. Defaults to the matrix values for this job; this should not be overridden by users (INTERNAL).
    workflow-job-context: # optional, default is ${{ toJSON(matrix) }}
    # When 'true', the action will attempt to remove any stale/unused entries from the Gradle User Home prior to saving to the GitHub Actions cache.
    gradle-home-cache-cleanup: # optional

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v2
        with:
          name: java-app
          path: '${{ github.workspace }}/target/*.jar'

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v2
        with:
          name: java-app

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'CaesarCipher'
          slot-name: 'Production'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_008CE4CD560C419C816F2D9D68326A77 }}
          package: '*.jar'
